<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crop Recommendation System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #4a5568;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #718096;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            color: #4a5568;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        
        .recommendations {
            margin-top: 20px;
        }
        
        .recommendation-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .crop-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .crop-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .detail-item {
            color: #4a5568;
        }
        
        .detail-label {
            font-weight: 500;
        }
        
        .confidence-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .confidence-fill {
            height: 100%;
            background: #48bb78;
            transition: width 0.5s;
        }
        
        .care-tips {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .care-tips h4 {
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .care-tips ul {
            margin-left: 20px;
            color: #4a5568;
        }
        
        .chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background: #f7fafc;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .user-message {
            background: #667eea;
            color: white;
            text-align: right;
        }
        
        .bot-message {
            background: white;
            color: #2d3748;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
        }
        
        .loading {
            text-align: center;
            color: #718096;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #e2e8f0;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .offline-indicator {
            background: #fed7d7;
            color: #c53030;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            display: none;
        }
        
        .offline .offline-indicator {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåæ AI Crop Recommendation System</h1>
            <p class="subtitle">Smart farming decisions powered by artificial intelligence</p>
            <span class="offline-indicator">Offline Mode</span>
        </header>
        
        <div class="main-content">
            <div class="card">
                <h2>Get Crop Recommendations</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('location')">Location Based</div>
                    <div class="tab" onclick="switchTab('manual')">Manual Input</div>
                </div>
                
                <div id="location-tab" class="tab-content active">
                    <form id="location-form">
                        <div class="form-group">
                            <label for="latitude">Latitude:</label>
                            <input type="number" id="latitude" name="latitude" step="0.0001" value="23.3441" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="longitude">Longitude:</label>
                            <input type="number" id="longitude" name="longitude" step="0.0001" value="85.3096" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="region">Region:</label>
                            <input type="text" id="region" name="region" value="Jharkhand" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="language">Language:</label>
                            <select id="language" name="language">
                                <option value="en">English</option>
                                <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
                            </select>
                        </div>
                        
                        <button type="submit">Get Recommendations</button>
                    </form>
                </div>
                
                <div id="manual-tab" class="tab-content">
                    <form id="manual-form">
                        <div class="form-group">
                            <label for="ph">Soil pH:</label>
                            <input type="number" id="ph" name="ph" step="0.1" min="4" max="10" placeholder="6.5">
                        </div>
                        
                        <div class="form-group">
                            <label for="nitrogen">Nitrogen (kg/ha):</label>
                            <input type="number" id="nitrogen" name="nitrogen" step="1" placeholder="150">
                        </div>
                        
                        <div class="form-group">
                            <label for="phosphorus">Phosphorus (kg/ha):</label>
                            <input type="number" id="phosphorus" name="phosphorus" step="1" placeholder="50">
                        </div>
                        
                        <div class="form-group">
                            <label for="potassium">Potassium (kg/ha):</label>
                            <input type="number" id="potassium" name="potassium" step="1" placeholder="200">
                        </div>
                        
                        <div class="form-group">
                            <label for="rainfall">Expected Rainfall (mm):</label>
                            <input type="number" id="rainfall" name="rainfall" step="1" placeholder="100">
                        </div>
                        
                        <button type="submit">Get Recommendations</button>
                    </form>
                </div>
                
                <div id="recommendations" class="recommendations"></div>
            </div>
            
            <div class="card">
                <h2>Ask Your Agricultural Assistant</h2>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message bot-message">
                            Hello! I'm your agricultural assistant. Ask me anything about farming, crops, diseases, or market prices.
                        </div>
                    </div>
                    
                    <div class="chat-input">
                        <input type="text" id="chat-input" placeholder="Type your question here...">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:8000';
        let isOffline = false;
        let offlineData = {};
        
        // Check if API is available
        async function checkConnection() {
            try {
                const response = await fetch(API_URL + '/', { method: 'GET' });
                if (!response.ok) throw new Error('API not available');
                isOffline = false;
                document.body.classList.remove('offline');
            } catch (error) {
                isOffline = true;
                document.body.classList.add('offline');
                loadOfflineData();
            }
        }
        
        // Load offline data
        async function loadOfflineData() {
            try {
                const response = await fetch(API_URL + '/offline-data');
                offlineData = await response.json();
                localStorage.setItem('offlineData', JSON.stringify(offlineData));
            } catch (error) {
                // Try to load from localStorage
                const stored = localStorage.getItem('offlineData');
                if (stored) {
                    offlineData = JSON.parse(stored);
                }
            }
        }
        
        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'location') {
                document.querySelector('.tabs .tab:first-child').classList.add('active');
                document.getElementById('location-tab').classList.add('active');
            } else {
                document.querySelector('.tabs .tab:last-child').classList.add('active');
                document.getElementById('manual-tab').classList.add('active');
            }
        }
        
        // Handle location form submission
        document.getElementById('location-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                location: {
                    latitude: parseFloat(formData.get('latitude')),
                    longitude: parseFloat(formData.get('longitude')),
                    region: formData.get('region')
                },
                language: formData.get('language')
            };
            
            await getRecommendations(data);
        });
        
        // Handle manual form submission
        document.getElementById('manual-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const soilData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value) {
                    soilData[key] = parseFloat(value);
                }
            }
            
            const data = {
                location: {
                    latitude: 23.3441,
                    longitude: 85.3096,
                    region: "Jharkhand"
                },
                soil_data: soilData,
                language: document.getElementById('language').value
            };
            
            await getRecommendations(data);
        });
        
        // Get recommendations from API
        async function getRecommendations(data) {
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Getting recommendations...</div>';
            
            try {
                if (isOffline) {
                    // Use offline recommendations
                    displayOfflineRecommendations(data);
                    return;
                }
                
                const response = await fetch(API_URL + '/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayRecommendations(result.recommendations, result.environmental_data);
                } else {
                    recommendationsDiv.innerHTML = '<p style="color: red;">Error getting recommendations</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                recommendationsDiv.innerHTML = '<p style="color: red;">Failed to connect to server</p>';
            }
        }
        
        // Display recommendations
        function displayRecommendations(recommendations, environmentalData) {
            const recommendationsDiv = document.getElementById('recommendations');
            let html = '<h3>Recommended Crops</h3>';
            
            if (environmentalData) {
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f7fafc; border-radius: 5px;">
                        <strong>Environmental Conditions:</strong><br>
                        Soil pH: ${environmentalData.soil.ph}<br>
                        Temperature: ${environmentalData.weather.temperature}¬∞C<br>
                        Humidity: ${environmentalData.weather.humidity}%
                    </div>
                `;
            }
            
            recommendations.forEach(rec => {
                html += `
                    <div class="recommendation-card">
                        <div class="crop-name">${rec.crop}</div>
                        <div class="crop-details">
                            <div class="detail-item">
                                <span class="detail-label">Confidence:</span> ${(rec.confidence * 100).toFixed(1)}%
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${rec.confidence * 100}%"></div>
                                </div>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Expected Yield:</span> ${rec.predicted_yield} tons/ha
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Profit Margin:</span> ${rec.profit_margin}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Est. Profit:</span> ‚Çπ${rec.estimated_profit}/ha
                            </div>
                        </div>
                        ${rec.market_info ? `
                            <div class="detail-item">
                                <span class="detail-label">Market Price:</span> ‚Çπ${rec.market_info.current_price}/quintal
                                (${rec.market_info.price_trend} trend, ${rec.market_info.demand} demand)
                            </div>
                        ` : ''}
                        <div class="care-tips">
                            <h4>Care Tips:</h4>
                            <ul>
                                ${rec.care_tips.map(tip => `<li>${tip}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            });
            
            recommendationsDiv.innerHTML = html;
        }
        
        // Display offline recommendations
        function displayOfflineRecommendations(data) {
            const recommendationsDiv = document.getElementById('recommendations');
            
            if (!offlineData.data || !offlineData.data.crop_database) {
                recommendationsDiv.innerHTML = '<p>Offline data not available</p>';
                return;
            }
            
            // Simple offline recommendation based on stored crop database
            const crops = Object.keys(offlineData.data.crop_database);
            const recommendations = crops.slice(0, 3).map(crop => {
                const cropInfo = offlineData.data.crop_database[crop];
                return {
                    crop: crop,
                    confidence: Math.random() * 0.3 + 0.6,
                    predicted_yield: Math.random() * 3 + 3,
                    estimated_profit: Math.random() * 50000 + 50000,
                    profit_margin: cropInfo.profit_margin,
                    sustainability_score: cropInfo.sustainability_score,
                    suitable_season: cropInfo.season,
                    care_tips: ["Consult local agricultural expert", "Monitor crop regularly"]
                };
            });
            
            displayRecommendations(recommendations, null);
        }
        
        // Send chat message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            const messagesDiv = document.getElementById('chat-messages');
            
            // Add user message
            messagesDiv.innerHTML += `<div class="message user-message">${message}</div>`;
            input.value = '';
            
            // Show loading
            messagesDiv.innerHTML += `<div class="message bot-message loading">Thinking...</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                if (isOffline) {
                    // Use offline responses
                    setTimeout(() => {
                        const loadingMsg = messagesDiv.querySelector('.loading');
                        loadingMsg.remove();
                        
                        const response = getOfflineResponse(message);
                        messagesDiv.innerHTML += `<div class="message bot-message">${response}</div>`;
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }, 500);
                    return;
                }
                
                const response = await fetch(API_URL + '/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: message,
                        language: document.getElementById('language').value
                    })
                });
                
                const result = await response.json();
                
                // Remove loading message
                const loadingMsg = messagesDiv.querySelector('.loading');
                loadingMsg.remove();
                
                if (result.status === 'success') {
                    const botResponse = formatChatResponse(result.response);
                    messagesDiv.innerHTML += `<div class="message bot-message">${botResponse}</div>`;
                } else {
                    messagesDiv.innerHTML += `<div class="message bot-message">Sorry, I couldn't process your request.</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                const loadingMsg = messagesDiv.querySelector('.loading');
                if (loadingMsg) loadingMsg.remove();
                messagesDiv.innerHTML += `<div class="message bot-message">Sorry, I'm having trouble connecting to the server.</div>`;
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Format chat response
        function formatChatResponse(response) {
            let html = response.message || '';
            
            if (response.suggestions && response.suggestions.length > 0) {
                html += '<br><br><strong>Suggestions:</strong><ul>';
                response.suggestions.forEach(suggestion => {
                    html += `<li>${suggestion}</li>`;
                });
                html += '</ul>';
            }
            
            if (response.current_weather) {
                html += '<br><strong>Current Weather:</strong><br>';
                html += `Temperature: ${response.current_weather.temperature}<br>`;
                html += `Humidity: ${response.current_weather.humidity}<br>`;
                html += `Rainfall: ${response.current_weather.rainfall}`;
            }
            
            if (response.current_prices) {
                html += '<br><strong>Market Prices:</strong><br>';
                for (let crop in response.current_prices) {
                    html += `${crop}: ${response.current_prices[crop].price}<br>`;
                }
            }
            
            return html;
        }
        
        // Get offline response
        function getOfflineResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return "Hello! I'm currently working offline, but I can still help with basic agricultural questions.";
            }
            
            if (lowerMessage.includes('crop') || lowerMessage.includes('recommend')) {
                return "For crop recommendations, please use the form on the left. In offline mode, I'll provide general recommendations based on cached data.";
            }
            
            if (lowerMessage.includes('weather')) {
                return "Weather data is not available in offline mode. Please check your local weather service.";
            }
            
            if (lowerMessage.includes('price') || lowerMessage.includes('market')) {
                return "Market prices are not available in offline mode. Please check with your local mandi when you're back online.";
            }
            
            return "I'm working in offline mode with limited capabilities. Please try again when you're connected to the internet for full functionality.";
        }
        
        // Allow Enter key to send message
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Check connection on load
        checkConnection();
        setInterval(checkConnection, 30000); // Check every 30 seconds
    </script>
</body>
</html>
